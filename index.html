<html>
  <head>
    <meta charset="utf-8" />
    <title>SelecciÃ³n de Sillas AR - Meta Touch Controls</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="./aframe-extras.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
    <!-- COMPONENTE DE ANIMACIÃ“N AL CLIC -->
    <script>
      AFRAME.registerComponent("chair-selector", {
        init: function () {
          const controllerEl = this.el;

          controllerEl.addEventListener("triggerdown", function () {
            const intersections = controllerEl.components.raycaster.intersections;

            if (intersections.length > 0) {
              const chair = intersections[0].object.el;

              // AnimaciÃ³n de rebote
              chair.setAttribute("animation__bounce", {
                property: "position",
                to: {
                  x: chair.object3D.position.x,
                  y: chair.object3D.position.y + 0.3,
                  z: chair.object3D.position.z
                },
                dur: 200,
                dir: "alternate",
                loop: 1,
                easing: "easeOutQuad"
              });

              // Eliminar animaciÃ³n despuÃ©s de ejecutarse
              setTimeout(() => {
                chair.removeAttribute("animation__bounce");
              }, 400);
            }
          });
        }
      });
    </script>
    <script>
      AFRAME.registerComponent("animation-toggle", {
        init: function () {
          const el = this.el;
          const originalClip = "triceratopsLowPolyv11_LODs";
          const triggeredClip = "@IdleBreak";

          el.addEventListener("triggerdown", function (evt) {
            const controller = evt.target;
            const intersections = controller.components.raycaster.intersections;

            if (intersections.length > 0) {
              const intersectedEl = intersections[0].object.el;
              if (intersectedEl === el) {
                // Cambiar a la animación de IdleBreak
                el.setAttribute("animation-mixer", {
                  clip: triggeredClip,
                  loop: "once",
                  timeScale: 1
                });

                // Esperar duración y volver a la animación original
                el.addEventListener("animation-finished", function restoreOriginal() {
                  el.setAttribute("animation-mixer", {
                    clip: originalClip,
                    loop: "repeat",
                    timeScale: 1
                  });
                  el.removeEventListener("animation-finished", restoreOriginal);
                });
              }
            }
          });
        }
      });
    </script>
  </head>

  <body>
    <a-scene vr-mode-ui="enabled: true" xrweb="ar: true" environment="preset: forest; ground: flat">
      <!-- MODELOS -->
      <a-assets>
        <a-asset-item id="chair-obj" src="./silla.obj"></a-asset-item>
        <a-asset-item id="chair-mtl" src="./Office_chairs.mtl"></a-asset-item>
        <a-asset-item
          src="https://cdn.aframe.io/examples/ar/models/triceratops/scene.gltf"
          response-type="arraybuffer"></a-asset-item>
      </a-assets>

      <!-- TRICERATOPS ANIMADO -->
      <a-entity
        id="triceratops"
        class="selectable"
        gltf-model="#triceratops"
        animation-mixer="clip: triceratopsLowPolyv11_LODs; loop: repeat; timeScale: 1"
        position="2 0 -3"
        scale="0.02 0.02 0.02"
        rotation="0 90 0">
      </a-entity>

      <!-- SILLAS SELECCIONABLES -->
      <a-entity
        class="selectable"
        obj-model="obj: #chair-obj; mtl: #chair-mtl"
        position="-2 0 -2"
        rotation="0 180 0"></a-entity>

      <!-- Camera -->
      <a-entity id="rig" movement-controls="speed: 0.01" position="0 0 0">
        <a-entity camera look-controls wasd-controls position="0 0 0"> </a-entity>

        <!-- CONTROLADORES DE META QUEST -->
        <a-entity
          id="left-controller"
          meta-touch-controls="hand: left"
          raycaster="objects: .selectable; showLine: true"
          line="color: cyan; opacity: 0.6"
          chair-selector
          animation-toggle>
        </a-entity>

        <a-entity
          id="right-controller"
          meta-touch-controls="hand: right"
          raycaster="objects: .selectable; showLine: true"
          line="color: cyan; opacity: 0.6"
          chair-selector
          animation-toggle>
        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
